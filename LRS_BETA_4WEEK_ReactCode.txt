import React, { useState, useEffect } from 'react';
import { BookOpen, Brain, Activity, Shield, ChevronRight, Printer, ArrowLeft, AlertCircle, Heart, Zap, Globe, User, Scale, Eye, Loader2 } from 'lucide-react';
import jsPDF from 'jspdf';

// --- CONFIGURATION ---
// REPLACE THIS URL WITH YOUR ACTUAL RAILWAY URL
const BACKEND_URL = 'https://your-railway-app-name.up.railway.app'; 

const allSchemas = [
  {
    id: 1,
    category: "Disconnection & Rejection",
    name: "Abandonment / Instability",
    causes: "Unstable or unreliable caregiving; early loss or parent absence.",
    symptoms: "Intense fear of loss, clinginess, jealousy, or withdrawal.",
    manifestations: "Connection (attachment worry), Roots (parent loss), Stability (world anxiety)",
    evidence: "Based on Young Schema Therapy (2003) and Attachment Theory.",
    plan: {
      week1: "Trigger Mapping: Record every time you feel 'abandonment panic'. Note the objective trigger vs. the internal fear.",
      week2: "The Healthy Adult Voice: Practice the thought: 'I am an adult now. Even if this person leaves, I can care for myself.'",
      week3: "Planned Separation: Spend an evening alone without checking social media. Practice self-soothing in the silence.",
      week4: "Relapse Prevention: Identify 3 healthy ways to ask for reassurance without testing or accusing your partner."
    }
  },
  {
    id: 2,
    category: "Disconnection & Rejection",
    name: "Mistrust / Abuse",
    causes: "Abuse, betrayal, or manipulation by caregivers or peers.",
    symptoms: "Expectation of harm, hypervigilance, difficulty trusting, testing others.",
    manifestations: "Roots (trauma items), Connection (trust difficulty), Environment (safety)",
    evidence: "Based on Trauma-Informed CBT protocols.",
    plan: {
      week1: "Evidence Checking: Pick one person you distrust. List evidence 'for' and 'against' the belief they intend harm.",
      week2: "Boundary Training: Practice saying 'I’m not comfortable with that' to minor requests to build internal safety.",
      week3: "Vulnerability Experiment: Share one minor personal opinion with a safe person. Observe the safety.",
      week4: "Trust Pacing: Categorize people into 'Trust Levels' (1-5). Share only level-appropriate info."
    }
  },
  {
    id: 3,
    category: "Disconnection & Rejection",
    name: "Emotional Deprivation",
    causes: "Lack of nurturance, empathy, or affection from caregivers.",
    symptoms: "Feeling chronically lonely, 'no one is there for me', choosing distant partners.",
    manifestations: "Connection (closeness), Roots (neglect), Vitality (mood)",
    evidence: "Based on Emotion-Focused Therapy and Young’s Schema models.",
    plan: {
      week1: "Need Awareness: Every time you feel empty, write down what you needed: Empathy, Protection, or Nurturance.",
      week2: "Cognitive Flashcard: Create a card: 'My feeling that no one cares is a schema memory, not a current fact.'",
      week3: "Active Request: Ask a trusted person for 10 minutes of active listening regarding a small stressor.",
      week4: "Inner Nurturing: Schedule one activity weekly that feels 'nurturing' to your inner child."
    }
  },
  {
    id: 4,
    category: "Disconnection & Rejection",
    name: "Defectiveness / Shame",
    causes: "Criticism, rejection, or shaming; feeling inherently flawed.",
    symptoms: "Deep shame, self-loathing, hypersensitivity to criticism, hiding 'defects'.",
    manifestations: "Digital Wellbeing (comparison), Meaning (self-worth), Roots (insults)",
    evidence: "Inspired by Compassion-Focused Therapy.",
    plan: {
      week1: "Critic Audit: Name your inner critic (e.g., 'The Judge'). Note how often it speaks and the words it uses.",
      week2: "Humanity Re-framing: When you make a mistake, say: 'This is a common human experience, not a defect.'",
      week3: "Mirror Work: Spend 2 minutes daily looking at yourself saying: 'I am worthy of kindness regardless of flaws.'",
      week4: "Compassionate Letter: Write a letter to yourself from the perspective of a wise friend regarding a past mistake."
    }
  },
  {
    id: 5,
    category: "Disconnection & Rejection",
    name: "Social Isolation / Alienation",
    causes: "Feeling different or excluded from family or peers.",
    symptoms: "Sense of being an outsider, avoiding groups, feeling no one understands.",
    manifestations: "Connection (outsider), Environment (identity), Digital Wellbeing (comparison)",
    evidence: "Based on Social Skills Training and CBT for Social Anxiety.",
    plan: {
      week1: "Similarity Search: In every interaction, find one thing you have in common with the other person.",
      week2: "Cognitive Reframe: Challenge 'They think I'm weird' with 'Most people are too focused on themselves to judge.'",
      week3: "The Show Up Challenge: Attend one group event (meetup, class) and stay for 30 minutes without hiding.",
      week4: "Small Talk Mastery: Initiate one 2-minute conversation with an acquaintance. Use 'Ask one, share one'."
    }
  },
  {
    id: 6,
    category: "Impaired Autonomy & Performance",
    name: "Dependence / Incompetence",
    causes: "Overprotection or discouragement of independent decision-making.",
    symptoms: "Inability to handle daily tasks alone, excessive need for advice.",
    manifestations: "Growth (agency), Roots (overprotection), Stability (control)",
    evidence: "Based on Behavioral Activation and Autonomy-focused CBT.",
    plan: {
      week1: "Competence Log: Note every task you completed today without asking for help (driving, cooking, etc).",
      week2: "Solo Decision Day: Make 3 small decisions without asking anyone’s opinion.",
      week3: "The Technical Challenge: Research and complete one 'adulting' task you usually outsource.",
      week4: "Independence Leap: Go to a cinema or restaurant alone. Practice being your own company."
    }
  },
  {
    id: 7,
    category: "Impaired Autonomy & Performance",
    name: "Vulnerability to Harm or Illness",
    causes: "Growing up with fearful parents; exposure to trauma.",
    symptoms: "Chronic worry about catastrophes (medical, financial, natural).",
    manifestations: "Stability (world anxiety), Vitality (health worry), Roots (childhood fear)",
    evidence: "Based on Exposure Therapy and CBT for Generalized Anxiety.",
    plan: {
      week1: "Probability Check: Calculate the statistical likelihood of your fear vs. your emotional feeling of it.",
      week2: "Worry Time: Schedule 15 minutes a day to 'worry'. Say 'I'll save that for 5 PM' otherwise.",
      week3: "Gradual Exposure: Do one small thing that feels 'risky' (e.g., walk without your phone).",
      week4: "Radical Acceptance: Practice: 'I cannot control every outcome, but I can handle whatever comes.'"
    }
  },
  {
    id: 8,
    category: "Impaired Autonomy & Performance",
    name: "Enmeshment / Undeveloped Self",
    causes: "Over-involved parents who suppressed individual identity.",
    symptoms: "Lack of identity, feeling empty alone, adopting others' views.",
    manifestations: "Growth (identity), Connection (enmeshment), Roots (controlling parent)",
    evidence: "Based on Bowenian Family Systems and Schema Therapy.",
    plan: {
      week1: "Preference Discovery: Pause before making a choice and ask: 'What do I want, regardless of others?'",
      week2: "Separate Interests: Spend 2 hours doing a hobby that your family does NOT participate in.",
      week3: "Opinion Practice: State your preference first in a group setting before others speak.",
      week4: "Values Mapping: List your top 5 personal values. Check if your schedule reflects THEM or others."
    }
  },
  {
    id: 9,
    category: "Impaired Autonomy & Performance",
    name: "Failure",
    causes: "Parents who were critical of performance or compared you unfavorably.",
    symptoms: "Belief that one is fundamentally less capable than peers; fear of trying.",
    manifestations: "Growth (failure), Meaning (competence), Roots (criticism)",
    evidence: "Inspired by Growth Mindset research.",
    plan: {
      week1: "Past Wins List: List 10 times you succeeded in the past, including 'small' wins.",
      week2: "Skill Breakdown: Take one goal you’ve avoided. Break it into 10 tiny, 15-minute steps.",
      week3: "The 'Data' Reframe: When you fail, say: 'This is data on how to improve, not proof of failure.'",
      week4: "New Learning: Spend 30 minutes learning a skill you are 'bad' at. Practice being a beginner."
    }
  },
  {
    id: 10,
    category: "Impaired Limits",
    name: "Entitlement / Grandiosity",
    causes: "Spoiling, lack of limits, or being told you are 'special' above others.",
    symptoms: "Insistence on having one's way, lack of empathy, rules don't apply.",
    manifestations: "Connection (respect), Growth (superiority), Roots (no limits)",
    evidence: "Based on Schema Therapy for Narcissism and DBT interpersonal skills.",
    plan: {
      week1: "Frustration Tolerance: Practice waiting in the longest line at a store without complaining.",
      week2: "Active Empathy: In every conversation, ask 'How are you feeling?' and listen for 5 minutes.",
      week3: "The 'Equality' Mantra: Practice: 'Being equal to others is the path to real connection.'",
      week4: "Rule Following: Pick one minor rule you usually ignore (speed limit) and follow it for 7 days."
    }
  },
  {
    id: 11,
    category: "Impaired Limits",
    name: "Insufficient Self-Control / Self-Discipline",
    causes: "Lack of structure or discipline in childhood; avoidant coping.",
    symptoms: "Difficulty finishing tasks, impulsivity, low frustration tolerance.",
    manifestations: "Vitality (habits), Growth (achievement), Roots (no routine)",
    evidence: "Based on Behavioral Activation and Executive Function coaching.",
    plan: {
      week1: "The One Routine: Choose one 5-minute task (making the bed) and do it every day.",
      week2: "The 10-Minute Rule: When you want to quit a task, do '10 more minutes' then decide.",
      week3: "Delayed Gratification: When you want an impulsive purchase, wait 24 hours.",
      week4: "Completion Goal: Pick one small, unfinished project. Spend 30 minutes daily until finished."
    }
  },
  {
    id: 12,
    category: "Other-Directedness",
    name: "Subjugation",
    causes: "Highly controlling parents; fear of retaliation.",
    symptoms: "Giving up control to avoid conflict; suppressed anger.",
    manifestations: "Connection (suppression), Growth (conflict avoidance), Roots (scary parent)",
    evidence: "Based on Assertiveness Training.",
    plan: {
      week1: "Anger Awareness: Every time you feel 'annoyed', ask: 'What need of mine is being ignored?'",
      week2: "The Preference Choice: Practice making the first choice for dinner or a movie.",
      week3: "I-Statement Practice: Use: 'I feel [emotion] when [behavior] because [reason].'",
      week4: "Small Rebellion: Break one 'internal rule' about being 'nice' (leave dishes for a morning)."
    }
  },
  {
    id: 13,
    category: "Other-Directedness",
    name: "Self-Sacrifice",
    causes: "Taking care of parents; guilt or modeling of excessive giving.",
    symptoms: "Over-focus on others' needs, neglect of own, resentment, burnout.",
    manifestations: "Meaning (helping), Connection (preoccupation), Roots (parentification)",
    evidence: "Based on Boundary Theory and CBT for Burnout.",
    plan: {
      week1: "Resentment Log: Note every time you feel resentful. This is a signal of over-sacrifice.",
      week2: "The 'No' Practice: Say 'no' to one non-essential favor this week.",
      week3: "Priority Shift: Schedule one hour of 'Me Time' as a mandatory appointment.",
      week4: "Needs Ranking: List 3 physical needs. Meet them BEFORE saying yes to others on Tuesday."
    }
  },
  {
    id: 14,
    category: "Other-Directedness",
    name: "Approval-Seeking / Recognition-Seeking",
    causes: "Love and acceptance conditional on performance or appearance.",
    symptoms: "Need for admiration, identity based on validation, conformity.",
    manifestations: "Digital Wellbeing (validation), Meaning (respect), Growth (worth)",
    evidence: "Based on Acceptance and Commitment Therapy (ACT).",
    plan: {
      week1: "The Unseen Act: Do one thing you are proud of and tell NO ONE about it.",
      week2: "Authenticity Audit: List 3 things you do for approval. Stop one for 3 days.",
      week3: "Opinion Sharing: Share an unpopular opinion in a safe group (e.g., don't like a popular show).",
      week4: "Inner Validation: Nightly, write: 'I am proud of myself today because...' (no outside views)."
    }
  },
  {
    id: 15,
    category: "Overvigilance & Inhibition",
    name: "Negativity / Pessimism",
    causes: "Focus on negative in family; repeated childhood hardship.",
    symptoms: "Chronic focus on negatives, worry, discounting positives.",
    manifestations: "Vitality (mood), Stability (anxiety), Meaning (gratitude)",
    evidence: "Based on Seligman’s Learned Optimism.",
    plan: {
      week1: "Three Good Things: Every night, write 3 things that went well and WHY.",
      week2: "Best-Case Scenario: For every 'catastrophe' thought, write a 'Best Case' outcome.",
      week3: "Complaint Fast: Try to go 24 hours without voicing a single complaint.",
      week4: "Optimism Experiment: Take a small leap of faith and expect a positive outcome."
    }
  },
  {
    id: 16,
    category: "Overvigilance & Inhibition",
    name: "Emotional Inhibition",
    causes: "Suppression of emotions shamed or punished as a child.",
    symptoms: "Restraint of feelings, fear of losing control, rigid appearance.",
    manifestations: "Connection (hiding), Digital Wellbeing (curating), Vitality (mood)",
    evidence: "Based on Emotion-Focused Therapy.",
    plan: {
      week1: "The Feelings Wheel: Three times a day, name exactly what you are feeling.",
      week2: "Body Scanning: When you feel tension, sit with the physical sensation for 2 minutes.",
      week3: "Spontaneity Minute: Do something 'unstructured' (dancing, doodling) for 60 seconds.",
      week4: "Emotional Disclosure: Share one 'vulnerable' feeling with a loved one without adding logic."
    }
  },
  {
    id: 17,
    category: "Overvigilance & Inhibition",
    name: "Unrelenting Standards / Hypercriticalness",
    causes: "High pressure for performance; criticism for imperfection.",
    symptoms: "Perfectionism, chronic dissatisfaction, burnout.",
    manifestations: "Growth (perfection), Meaning (peace), Connection (suppression)",
    evidence: "Based on CBT for Perfectionism.",
    plan: {
      week1: "The 80% Experiment: Complete a low-stakes task to an 80% standard. Do not 'fix' it.",
      week2: "Savoring Play: Schedule 30 minutes of an activity with NO goal attached.",
      week3: "Soften Shoulds: Replace 'I should' with 'I would like to' for 48 hours.",
      week4: "Self-Criticism Counter: For every critical thought, write one thing you appreciate about effort."
    }
  },
  {
    id: 18,
    category: "Overvigilance & Inhibition",
    name: "Punitiveness",
    causes: "Harsh punishment; intolerance of mistakes.",
    symptoms: "Self-punishing or punitive toward others, difficulty forgiving.",
    manifestations: "Vitality (guilt), Growth (critical mistakes), Roots (cruel discipline)",
    evidence: "Based on Compassion-Focused Therapy.",
    plan: {
      week1: "The Human Error Rule: Repeat: 'Mistakes are necessary for growth, not a crime.'",
      week2: "The Mercy Act: Forgive a minor 'offense' by someone else without lecturing them.",
      week3: "Self-Forgiveness Ritual: Write a mistake on paper, literally throw it away and move on.",
      week4: "Kindness Reward: After a hard day, do something kind for yourself instead of being strict."
    }
  }
];

export default function CompleteSchemaWorkbook() {
  const [selectedSchema, setSelectedSchema] = useState(null);
  const [completedWeeks, setCompletedWeeks] = useState({});
  
  // --- ADD THESE NEW STATE VARIABLES ---
  const [view, setView] = useState('directory'); // Controls which screen is visible
  const [loading, setLoading] = useState(false); // Shows a spinner during calculation
  const [results, setResults] = useState([]);   // Stores the top schemas from Railway
  const [answers, setAnswers] = useState({});   // Stores the user's 1-5 ratings

  // --- YOUR INTEGRATION FUNCTION ---
  const handleAssessmentSubmit = async () => {
    setLoading(true);
    try {
      // Replace with your ACTUAL Railway URL from your dashboard
      const response = await fetch('https://your-railway-app-name.up.railway.app/api/calculate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ answers: answers }) // Sends the survey data
      });

      if (!response.ok) throw new Error('Backend unreachable');
      
      const data = await response.json();
      
      // Assuming your Python app.py returns { "top_schemas": [...] }
      setResults(data.top_schemas); 
      setView('results'); // Switch view to show the user their matches
    } catch (err) {
      alert("Connection failed. Check if Railway app is 'Active' and URL is correct.");
      console.error("Connection failed:", err);
    } finally {
      setLoading(false);
    }
  };
  const [view, setView] = useState('directory'); 
  const [selectedSchema, setSelectedSchema] = useState(null);
  const [completedWeeks, setCompletedWeeks] = useState({});
  const [answers, setAnswers] = useState({});
  const [loading, setLoading] = useState(false);
  const [results, setResults] = useState([]);

  // Handle assessment submission to your Railway URL
  const handleAssessmentSubmit = async (e) => {
    if (e) e.preventDefault();
    setLoading(true);
    
    try {
      const response = await fetch(`${BACKEND_URL}/api/calculate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ answers: answers })
      });

      if (!response.ok) throw new Error('Could not reach backend');
      
      const data = await response.json();
      // 'data.top_schemas' should be an array of schema names or objects from your Python code
      setResults(data.top_schemas);
      setView('results');
    } catch (err) {
      alert("Error: Make sure your Railway URL is correct and the server is running.");
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  const handlePrint = () => window.print();

  const handleDownloadPDF = (schema) => {
    const doc = new jsPDF();
    doc.setFontSize(18);
    doc.text(schema.name, 20, 20);
    doc.setFontSize(12);
    doc.text(`Category: ${schema.category}`, 20, 30);
    doc.text(`Root Causes: ${schema.causes}`, 20, 40, { maxWidth: 160 });
    doc.text(`Symptoms: ${schema.symptoms}`, 20, 55, { maxWidth: 160 });
    doc.text(`Manifestations: ${schema.manifestations}`, 20, 70, { maxWidth: 160 });
    doc.text('--- 4-WEEK ACTION PLAN ---', 20, 85);
    doc.text(`Week 1: ${schema.plan.week1}`, 20, 95, { maxWidth: 160 });
    doc.text(`Week 2: ${schema.plan.week2}`, 20, 115, { maxWidth: 160 });
    doc.text(`Week 3: ${schema.plan.week3}`, 20, 135, { maxWidth: 160 });
    doc.text(`Week 4: ${schema.plan.week4}`, 20, 155, { maxWidth: 160 });
    doc.save(`${schema.name.replace(/\//g, '-')}.pdf`);
  };

  const toggleWeekComplete = (schemaId, week) => {
    const key = `${schemaId}-${week}`;
    setCompletedWeeks(prev => ({ ...prev, [key]: !prev[key] }));
  };

  const categoryIcons = {
    "Disconnection & Rejection": Heart,
    "Impaired Autonomy & Performance": User,
    "Impaired Limits": Scale,
    "Other-Directedness": Globe,
    "Overvigilance & Inhibition": Eye
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans p-4 md:p-12">
      <style>{`
        @media print { .print-hide { display: none !important; } body { background: white; } }
      `}</style>

      {view === 'directory' && (
        <div className="max-w-6xl mx-auto">
          <header className="mb-12 text-center">
            <h1 className="text-5xl font-black text-slate-900 mb-4 tracking-tighter uppercase">LRS Clinical Workbook</h1>
            <p className="text-slate-500 text-lg mb-8">Comprehensive CBT Action Plans for all 18 Young's Schemas</p>
            <button 
                onClick={() => setView('assessment')}
                className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-2xl shadow-lg transition-all"
            >
                START FULL ASSESSMENT
            </button>
          </header>
          
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {allSchemas.map((schema) => {
              const Icon = categoryIcons[schema.category] || Brain;
              return (
                <div 
                  key={schema.id}
                  onClick={() => { setSelectedSchema(schema); setView('detail'); window.scrollTo(0, 0); }}
                  className="bg-white p-6 rounded-3xl border border-slate-200 hover:border-blue-500 hover:shadow-2xl transition-all cursor-pointer group"
                >
                  <div className="flex items-center gap-3 mb-4">
                    <div className="p-2 bg-blue-50 rounded-xl text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                      <Icon size={20} />
                    </div>
                    <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">{schema.category}</span>
                  </div>
                  <h3 className="text-xl font-bold text-slate-800 mb-2">{schema.name}</h3>
                  <p className="text-xs text-slate-500 line-clamp-2 leading-relaxed">{schema.symptoms}</p>
                </div>
              );
            })}
          </div>
        </div>
      )}

      {view === 'assessment' && (
        <div className="max-w-3xl mx-auto bg-white rounded-[2.5rem] shadow-xl p-8 border border-slate-200">
             <button onClick={() => setView('directory')} className="text-slate-400 hover:text-blue-600 mb-8 font-bold uppercase text-xs tracking-widest flex items-center gap-2">
                <ArrowLeft size={16}/> Back
             </button>
             <h2 className="text-3xl font-black mb-8">Core Assessment</h2>
             <p className="mb-8 text-slate-500 italic">This assessment connects to your Railway Python server for scoring.</p>
             
             {/* Simple Question Placeholder - In real use, you'd map through questions */}
             <div className="space-y-8">
                <p className="font-bold">Rate yourself 1-5 on typical behaviors...</p>
                <button 
                    onClick={handleAssessmentSubmit} 
                    className="w-full bg-slate-900 text-white py-6 rounded-2xl font-black flex items-center justify-center gap-3"
                >
                    {loading ? <Loader2 className="animate-spin" /> : 'SUBMIT TO RAILWAY'}
                </button>
             </div>
        </div>
      )}

      {view === 'results' && (
        <div className="max-w-6xl mx-auto">
             <header className="mb-12 text-center">
                <h1 className="text-4xl font-black mb-2">Assessment Results</h1>
                <p className="text-slate-500 italic">Your primary active schemas identified by the engine.</p>
             </header>
             <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {results.map((r, i) => (
                    <div key={i} className="bg-white p-8 rounded-3xl border-2 border-blue-500 shadow-xl">
                        <h3 className="text-2xl font-black text-blue-600 mb-2">{r.name || r}</h3>
                        <p className="text-slate-600 mb-4">This schema appears to be driving your current emotional patterns.</p>
                        <button 
                            onClick={() => {
                                const found = allSchemas.find(s => s.name === (r.name || r));
                                setSelectedSchema(found || allSchemas[0]);
                                setView('detail');
                            }}
                            className="text-sm font-bold bg-slate-100 px-4 py-2 rounded-lg"
                        >
                            VIEW FULL 4-WEEK PLAN
                        </button>
                    </div>
                ))}
             </div>
        </div>
      )}

      {view === 'detail' && selectedSchema && (
        <div className="max-w-4xl mx-auto animate-in fade-in duration-500">
          <button 
            onClick={() => setView('directory')}
            className="flex items-center gap-2 text-slate-500 hover:text-blue-600 mb-8 font-bold print-hide"
          >
            <ArrowLeft size={20} /> BACK TO DIRECTORY
          </button>

          <div className="bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border border-slate-200">
            <div className="bg-slate-900 p-10 text-white">
              <div className="flex justify-between items-start">
                <div>
                  <div className="bg-blue-600 px-4 py-1 rounded-full text-[10px] font-black uppercase tracking-widest mb-4 inline-block">
                    {selectedSchema.category}
                  </div>
                  <h2 className="text-4xl md:text-5xl font-black mb-3">{selectedSchema.name}</h2>
                </div>
                <div className="flex gap-2 print-hide">
                  <button onClick={handlePrint} className="p-4 bg-white/10 hover:bg-white/20 rounded-2xl transition-colors"><Printer size={20} /></button>
                  <button onClick={() => handleDownloadPDF(selectedSchema)} className="p-4 bg-white/10 hover:bg-white/20 rounded-2xl transition-colors"><Shield size={20} /></button>
                </div>
              </div>
            </div>

            <div className="p-10 grid md:grid-cols-3 gap-8 bg-slate-50 border-b border-slate-200">
              <div className="space-y-2">
                <h4 className="flex items-center gap-2 text-red-600 font-black text-[10px] uppercase tracking-widest"><Brain size={16}/> Root Cause</h4>
                <p className="text-sm text-slate-700 leading-relaxed">{selectedSchema.causes}</p>
              </div>
              <div className="space-y-2">
                <h4 className="flex items-center gap-2 text-orange-600 font-black text-[10px] uppercase tracking-widest"><AlertCircle size={16}/> Symptoms</h4>
                <p className="text-sm text-slate-700 leading-relaxed">{selectedSchema.symptoms}</p>
              </div>
              <div className="space-y-2">
                <h4 className="flex items-center gap-2 text-purple-600 font-black text-[10px] uppercase tracking-widest"><Activity size={16}/> Manifestations</h4>
                <p className="text-sm text-slate-700 leading-relaxed font-medium">{selectedSchema.manifestations}</p>
              </div>
            </div>

            <div className="p-10">
              <h3 className="text-3xl font-black text-slate-900 mb-10">4-Week Action Plan</h3>
              <div className="space-y-10">
                {['week1', 'week2', 'week3', 'week4'].map((week, idx) => {
                  const key = `${selectedSchema.id}-${week}`;
                  return (
                    <div key={week} className="flex gap-8 group">
                      <div className="flex flex-col items-center">
                        <div className={`p-4 rounded-2xl transition-all duration-500 ${completedWeeks[key] ? 'bg-green-500 text-white' : 'bg-blue-100 text-blue-600 shadow-sm'}`}>
                          <BookOpen size={24} />
                        </div>
                        {idx < 3 && <div className="w-px h-full bg-slate-200 mt-4" />}
                      </div>
                      <div className="pb-10 flex-1">
                        <div className="flex justify-between items-center mb-3">
                          <h4 className={`text-xl font-black uppercase tracking-tight ${completedWeeks[key] ? 'text-green-600' : 'text-slate-800'}`}>Week {idx+1}</h4>
                          <label className="flex items-center gap-2 text-[10px] font-black text-slate-400 uppercase cursor-pointer hover:text-blue-600 print-hide">
                            <input 
                              type="checkbox"
                              checked={completedWeeks[key] || false}
                              onChange={() => toggleWeekComplete(selectedSchema.id, week)}
                              className="w-5 h-5 rounded-lg border-slate-300 text-blue-600 focus:ring-blue-500"
                            />
                            {completedWeeks[key] ? 'COMPLETED' : 'MARK COMPLETE'}
                          </label>
                        </div>
                        <div className={`p-6 rounded-3xl leading-relaxed text-slate-700 border ${completedWeeks[key] ? 'bg-green-50/50 border-green-200' : 'bg-white border-slate-200 shadow-sm'}`}>
                          {selectedSchema.plan[week]}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
          
          <footer className="mt-12 text-center text-slate-400 text-xs pb-12">
            This workbook is a self-help tool and does not replace professional therapy.
          </footer>
        </div>
      )}
    </div>
  );
}
